<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë‚´ ê°ì • ì¼ê¸°</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'emotion-happy': '#10B981',
            'emotion-sad': '#3B82F6',
            'emotion-angry': '#EF4444',
            'emotion-anxious': '#F59E0B',
            'emotion-neutral': '#6B7280'
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'bounce-in': 'bounceIn 0.6s ease-out'
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.3); }
      50% { opacity: 1; transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .emotion-card {
      transition: all 0.3s ease;
    }

    .emotion-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .emotion-happy {
      background: linear-gradient(135deg, #d4fdd4 0%, #c6f6d5 100%);
      border-left: 4px solid #10B981;
    }

    .emotion-sad {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-left: 4px solid #3B82F6;
    }

    .emotion-angry {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-left: 4px solid #EF4444;
    }

    .emotion-anxious {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #F59E0B;
    }

    .emotion-neutral {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-left: 4px solid #6B7280;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="navbar">
    <div class="nav-container">
      <a href="dashboard.html" class="nav-brand">ğŸŒ™ í•œ ìˆ¨ì˜ ìœ„ë¡œ</a>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">ëŒ€ì‹œë³´ë“œ</a>
        </li>
        <li class="nav-item">
          <a href="write-diary.html" class="nav-link">ì¼ê¸° ì‘ì„±</a>
        </li>
        <li class="nav-item">
          <a href="my-diary.html" class="nav-link active">ë‚´ ì¼ê¸°</a>
        </li>
        <li class="nav-item">
          <a href="anonymous-community.html" class="nav-link">ìµëª… ì»¤ë®¤ë‹ˆí‹°</a>
        </li>
        <li class="nav-item">
          <a href="stats.html" class="nav-link">í†µê³„</a>
        </li>
        <li class="nav-item">
          <a href="my-page.html" class="nav-link">ë§ˆì´í˜ì´ì§€</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="max-w-4xl mx-auto px-4 py-6 pt-24">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="gradient-bg rounded-3xl p-8 text-white mb-6 animate-fade-in">
        <h1 class="text-4xl font-bold mb-3">ğŸ“˜ ë‚´ ê°ì • ì¼ê¸°</h1>
        <p class="text-lg opacity-90">ë‚˜ë§Œì˜ ì†Œì¤‘í•œ ê°ì • ì—¬í–‰ì„ ë˜ëŒì•„ë³´ì„¸ìš”</p>
        <div class="mt-4 text-sm opacity-80">
          ğŸ“ ê°œì¸ ê¸°ë¡ ë³´ê´€ì†Œ Â· ğŸ­ ê°ì •ë³„ í•„í„°ë§ Â· ğŸ“… ë‚ ì§œë³„ ê²€ìƒ‰
        </div>
      </div>
    </div>

    <!-- Control Bar -->
    <div class="bg-white rounded-2xl p-6 shadow-lg mb-8 animate-slide-up">
      <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
        <!-- New Diary Button -->
        <button onclick="location.href='write-diary.html'"
                class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
          âœï¸ ìƒˆ ì¼ê¸° ì‘ì„±í•˜ê¸°
        </button>

        <!-- Filters -->
        <div class="flex flex-col sm:flex-row gap-4">
          <!-- Date Filter -->
          <div class="flex items-center space-x-2">
            <div class="text-indigo-600 text-lg">ğŸ“…</div>
            <input type="date" id="date-filter"
                   class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-300">
          </div>

          <!-- Emotion Filter -->
          <div class="flex items-center space-x-2">
            <label for="emotion-filter" class="text-gray-700 font-medium whitespace-nowrap">ğŸ­ ê°ì •</label>
            <select id="emotion-filter"
                    class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-300">
              <option value="all">ì „ì²´</option>
              <option value="happy">ğŸ˜Š í–‰ë³µ</option>
              <option value="sad">ğŸ˜¢ ìŠ¬í””</option>
              <option value="angry">ğŸ˜  ë¶„ë…¸</option>
              <option value="anxious">ğŸ˜Ÿ ë¶ˆì•ˆ</option>
              <option value="neutral">ğŸ˜ ë³´í†µ</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Diary List -->
    <div id="diary-list" class="space-y-4">
      <div class="text-center py-12">
        <div class="animate-spin w-8 h-8 border-2 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-gray-500">ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './js/supabase.js';
    import { checkAuth } from './js/auth.js';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    (async function init() {
      await checkAuth(); // ì¸ì¦ í™•ì¸ ë¨¼ì €

      const diaryList = document.getElementById('diary-list');
      const emotionFilter = document.getElementById('emotion-filter');
      const dateFilter = document.getElementById('date-filter');

      const emotionMap = {
        happy: 'ğŸ˜Š í–‰ë³µ',
        sad: 'ğŸ˜¢ ìŠ¬í””',
        angry: 'ğŸ˜  ë¶„ë…¸',
        anxious: 'ğŸ˜Ÿ ë¶ˆì•ˆ',
        neutral: 'ğŸ˜ ë³´í†µ'
      };

      const colorClassMap = {
        happy: 'color-happy',
        sad: 'color-sad',
        angry: 'color-angry',
        anxious: 'color-anxious',
        neutral: 'color-neutral'
      };

      let diaries = [];

      async function fetchDiaries() {
      try {
        console.log('ğŸ” fetchDiaries ì‹œì‘');

        // ì„¸ì…˜ í™•ì¸
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();

        console.log('ğŸ“‹ ì„¸ì…˜ í™•ì¸ ê²°ê³¼:', {
          hasSession: !!session,
          userId: session?.user?.id,
          sessionError: sessionError
        });

        if (sessionError || !session) {
          console.error('âŒ ì„¸ì…˜ ì˜¤ë¥˜:', sessionError);
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = 'login.html';
          return;
        }

        console.log('âœ… í˜„ì¬ ì‚¬ìš©ì ID:', session.user.id);

        // RLSê°€ ìë™ìœ¼ë¡œ í˜„ì¬ ì‚¬ìš©ìì˜ ì¼ê¸°ë§Œ ê°€ì ¸ì˜´
        console.log('ğŸ“¡ Supabaseì—ì„œ ì¼ê¸° ì¡°íšŒ ì‹œì‘...');
        const { data, error } = await supabase
          .from('diaries')
          .select('id, content, emotion, created_at')
          .order('created_at', { ascending: false });

        console.log('ğŸ“¡ Supabase ì‘ë‹µ:', {
          dataLength: data?.length,
          hasError: !!error,
          error: error
        });

        if (error) {
          console.error('âŒ ì¼ê¸° ì¡°íšŒ ì˜¤ë¥˜:', error);
          alert('ì¼ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
          return;
        }

        console.log('âœ… ì¡°íšŒëœ ì¼ê¸° ìˆ˜:', data?.length || 0);
        if (data && data.length > 0) {
          console.log('ğŸ“ ì²« ë²ˆì§¸ ì¼ê¸°:', data[0]);
        }

        diaries = data || [];
        renderDiaries();
      } catch (err) {
        console.error('âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:', err);
        alert('ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      function renderDiaries() {
      console.log('ğŸ¨ renderDiaries ì‹œì‘');
      console.log('ğŸ“Š ì „ì²´ ì¼ê¸° ìˆ˜:', diaries.length);

      const selectedEmotion = emotionFilter.value;
      const selectedDate = dateFilter.value;

      console.log('ğŸ” í•„í„° ì„¤ì •:', {
        selectedEmotion,
        selectedDate
      });

      const filtered = diaries.filter(d => {
        const emotionMatch = selectedEmotion === 'all' || d.emotion === selectedEmotion;
        const dateMatch = !selectedDate || d.created_at.startsWith(selectedDate);
        return emotionMatch && dateMatch;
      });

      console.log('âœ… í•„í„°ë§ëœ ì¼ê¸° ìˆ˜:', filtered.length);

      diaryList.innerHTML = '';

      if (filtered.length === 0) {
        diaryList.innerHTML = `
          <div class="text-center py-16">
            <div class="text-6xl mb-6">ğŸ“</div>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">ì•„ì§ ì‘ì„±í•œ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-gray-600 mb-6">ì²« ë²ˆì§¸ ê°ì • ì¼ê¸°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            <button onclick="location.href='write-diary.html'"
                    class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
              âœï¸ ì¼ê¸° ì“°ëŸ¬ ê°€ê¸°
            </button>
          </div>
        `;
        return;
      }

      console.log('ğŸ”¨ ì¹´ë“œ ìƒì„± ì‹œì‘');

      filtered.forEach((diary, index) => {
        console.log(`ğŸ“ ì¹´ë“œ ${index + 1}/${filtered.length} ìƒì„± ì¤‘:`, diary.id);

        const card = document.createElement('div');
        card.className = `emotion-card rounded-2xl p-6 shadow-lg animate-slide-up emotion-${diary.emotion}`;
        card.style.animationDelay = `${index * 0.1}s`;

        const emotionText = emotionMap[diary.emotion] || diary.emotion;
        const date = new Date(diary.created_at).toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          weekday: 'long'
        });

        const previewText = diary.content.length > 150
          ? diary.content.substring(0, 150) + '...'
          : diary.content;

        card.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <span class="text-2xl">${emotionText.split(' ')[0]}</span>
              <div>
                <h3 class="font-bold text-lg text-gray-800">${emotionText}</h3>
                <p class="text-sm text-gray-500">${date}</p>
              </div>
            </div>
            <div class="text-xs bg-white bg-opacity-60 px-3 py-1 rounded-full">
              ${diary.emotion}
            </div>
          </div>

          <div class="mb-4">
            <p class="text-gray-700 leading-relaxed">${previewText}</p>
          </div>

          <div class="flex justify-between items-center">
            <div class="text-xs text-gray-500">
              ${diary.content.length}ì
            </div>
            <button onclick="location.href='diary-detail.html?id=${diary.id}'"
                    class="px-4 py-2 bg-white bg-opacity-80 hover:bg-opacity-100 text-gray-700 font-medium rounded-lg transition-all duration-300 hover:scale-105 shadow-sm hover:shadow-md">
              ìƒì„¸ ë³´ê¸° â†’
            </button>
          </div>
        `;

        diaryList.appendChild(card);
        console.log(`âœ… ì¹´ë“œ ${index + 1} DOMì— ì¶”ê°€ ì™„ë£Œ`);
        });

      console.log('ğŸ‰ renderDiaries ì™„ë£Œ');
      }

      emotionFilter.addEventListener('change', renderDiaries);
      dateFilter.addEventListener('change', renderDiaries);

      const urlParams = new URLSearchParams(window.location.search);
      const initialEmotion = urlParams.get('emotion');
      if (initialEmotion) {
        emotionFilter.value = initialEmotion;
      }

      fetchDiaries();
    })(); // init í•¨ìˆ˜ ì¦‰ì‹œ ì‹¤í–‰
  </script>

</body>
</html>
