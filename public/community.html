<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>공유 일기 커뮤니티</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'emotion-happy': '#10B981',
            'emotion-sad': '#3B82F6',
            'emotion-angry': '#EF4444',
            'emotion-anxious': '#F59E0B',
            'emotion-neutral': '#6B7280'
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'bounce-in': 'bounceIn 0.6s ease-out'
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.3); }
      50% { opacity: 1; transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .emotion-filter.active {
      background: linear-gradient(135deg, #667eea, #764ba2) !important;
      color: white !important;
      border-color: #667eea !important;
      transform: scale(1.05);
    }

    .diary-card {
      transition: all 0.3s ease;
    }

    .diary-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="navbar">
    <div class="nav-container">
      <a href="dashboard.html" class="nav-brand">🌙 한 숨의 위로</a>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">대시보드</a>
        </li>
        <li class="nav-item">
          <a href="write-diary.html" class="nav-link">일기 작성</a>
        </li>
        <li class="nav-item">
          <a href="my-diary.html" class="nav-link">내 일기</a>
        </li>
        <li class="nav-item">
          <a href="anonymous-community.html" class="nav-link">익명 커뮤니티</a>
        </li>
        <li class="nav-item">
          <a href="stats.html" class="nav-link">통계</a>
        </li>
        <li class="nav-item">
          <a href="my-page.html" class="nav-link">마이페이지</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="max-w-4xl mx-auto px-4 py-6 pt-24">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="gradient-bg rounded-2xl p-8 text-white mb-6 animate-fade-in">
        <h1 class="text-3xl font-bold mb-2">🌍 공유 일기 커뮤니티</h1>
        <p class="text-lg opacity-90">다른 사람들과 감정을 나누고 공감하는 따뜻한 공간</p>
        <div class="mt-4 text-sm opacity-80">
          🤝 서로 공감하며 · 🎵 음악 추천 공유 · 📚 감정 이야기 나눔
        </div>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="bg-white rounded-2xl p-6 shadow-sm mb-6 animate-slide-up">
      <div class="mb-6">
        <div class="relative">
          <input type="text" id="search-input"
                 class="w-full p-4 pr-12 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all duration-300"
                 placeholder="키워드로 일기 검색하기... (감정, 내용, 피드백)" />
          <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">
            🔍
          </div>
        </div>
      </div>

      <div>
        <h3 class="text-lg font-semibold mb-4 text-gray-800">🎭 감정으로 찾아보기</h3>
        <div class="flex flex-wrap gap-3">
          <button class="emotion-filter active px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 bg-indigo-100 text-indigo-700 border-2 border-indigo-200" data-emotion="all">
            🌟 전체
          </button>
          <button class="emotion-filter px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 hover:bg-emotion-happy hover:text-white border-2 border-gray-200" data-emotion="happy">
            😊 행복
          </button>
          <button class="emotion-filter px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 hover:bg-emotion-sad hover:text-white border-2 border-gray-200" data-emotion="sad">
            😢 슬픔
          </button>
          <button class="emotion-filter px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 hover:bg-emotion-angry hover:text-white border-2 border-gray-200" data-emotion="angry">
            😠 분노
          </button>
          <button class="emotion-filter px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 hover:bg-emotion-anxious hover:text-white border-2 border-gray-200" data-emotion="anxious">
            😟 불안
          </button>
          <button class="emotion-filter px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 hover:bg-emotion-neutral hover:text-white border-2 border-gray-200" data-emotion="neutral">
            😐 보통
          </button>
        </div>
      </div>
    </div>

    <!-- Diary List -->
    <div id="diary-list" class="space-y-6">
      <div class="text-center py-12">
        <div class="animate-spin w-8 h-8 border-2 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-gray-500">공유된 일기를 불러오는 중...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './js/supabase.js';
    import { checkAuth } from './js/auth.js';

    checkAuth();

    const diaryList = document.getElementById('diary-list');
    const buttons = document.querySelectorAll('.emotion-filter');
    const searchInput = document.getElementById('search-input');

    let sharedDiaries = [];
    let currentUserId = null;
    let currentSubscriptions = [];

    async function loadSharedDiaries() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUserId = user.id;

      const { data: subs } = await supabase
        .from('subscriptions')
        .select('following_id')
        .eq('follower_id', currentUserId);

      currentSubscriptions = subs.map(s => s.following_id);

      const { data, error } = await supabase
        .from('shared_diaries')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        diaryList.innerHTML = '<p>일기를 불러오는 중 오류가 발생했습니다.</p>';
        return;
      }

      sharedDiaries = data;
      renderDiaries('all', '');
    }

    function renderDiaries(filter, keyword = '') {
      diaryList.innerHTML = '';

      const keywordLower = keyword.toLowerCase();
      const filtered = sharedDiaries.filter(d => {
        const matchesEmotion = filter === 'all' || d.emotion === filter;
        const matchesKeyword =
          d.content.toLowerCase().includes(keywordLower) ||
          d.feedback.toLowerCase().includes(keywordLower);
        return matchesEmotion && matchesKeyword;
      });

      if (filtered.length === 0) {
        diaryList.innerHTML = `
          <div class="text-center py-16">
            <div class="text-6xl mb-6">📝</div>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">공유된 일기가 없습니다</h3>
            <p class="text-gray-600 mb-6">첫 번째 감정 일기를 공유해보세요!</p>
          </div>
        `;
        return;
      }

      filtered.forEach((entry, index) => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 animate-slide-up';
        card.style.animationDelay = `${index * 0.1}s`;

        const anonId = `anon-${entry.user_id.slice(0, 4)}`;
        const isOwnPost = entry.user_id === currentUserId;
        const isSubscribed = currentSubscriptions.includes(entry.user_id);

        const emotionEmojis = {
          'happy': '😊',
          'sad': '😢',
          'angry': '😠',
          'anxious': '😟',
          'neutral': '😐'
        };

        const emotionColors = {
          'happy': 'bg-emerald-100 text-emerald-700 border-emerald-200',
          'sad': 'bg-blue-100 text-blue-700 border-blue-200',
          'angry': 'bg-red-100 text-red-700 border-red-200',
          'anxious': 'bg-amber-100 text-amber-700 border-amber-200',
          'neutral': 'bg-gray-100 text-gray-700 border-gray-200'
        };

        const emotionEmoji = emotionEmojis[entry.emotion] || '😐';
        const emotionColor = emotionColors[entry.emotion] || 'bg-gray-100 text-gray-700 border-gray-200';

        const date = new Date(entry.created_at).toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        card.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm">
                ${anonId.slice(-2).toUpperCase()}
              </div>
              <div>
                <h4 class="font-semibold text-gray-800">${anonId}</h4>
                <p class="text-sm text-gray-500">${date}</p>
              </div>
            </div>
            <div class="px-3 py-1 rounded-full text-xs font-medium border-2 ${emotionColor}">
              ${emotionEmoji} ${entry.emotion}
            </div>
          </div>

          <div class="mb-4">
            <p class="text-gray-700 leading-relaxed mb-3">${entry.content}</p>
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border-l-4 border-indigo-400 mb-3">
              <p class="text-sm text-gray-700"><span class="font-semibold text-indigo-700">🤖 AI 피드백:</span> ${entry.feedback}</p>
            </div>
          </div>

          <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="flex items-center space-x-3">
              <button class="like-btn flex items-center space-x-1 px-3 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-full transition-all duration-300 text-sm font-medium" data-id="${entry.id}">
                <span>❤️</span>
                <span id="likes-${entry.id}">${entry.likes || 0}</span>
              </button>

              ${entry.music ? `
                <a href="${entry.music}" target="_blank"
                   class="flex items-center space-x-1 px-3 py-2 bg-green-50 hover:bg-green-100 text-green-600 rounded-full transition-all duration-300 text-sm font-medium">
                  <span>🎵</span>
                  <span>음악 들기</span>
                </a>
              ` : ''}
            </div>

            ${!isOwnPost ? `
              <button class="subscribe-btn px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 ${isSubscribed
                ? 'bg-green-100 text-green-700 cursor-not-allowed opacity-75'
                : 'bg-indigo-100 hover:bg-indigo-200 text-indigo-700 hover:shadow-md transform hover:scale-105'
              }" data-uid="${entry.user_id}" ${isSubscribed ? 'disabled' : ''}>
                ${isSubscribed ? '✔️ 구독 중' : '📩 구독하기'}
              </button>
            ` : ''}
          </div>
        `;
        diaryList.appendChild(card);
      });

      attachLikeHandlers();
      attachSubscribeHandlers();
    }

    function attachLikeHandlers() {
      diaryList.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          btn.disabled = true;

          const countEl = document.getElementById(`likes-${id}`);
          const currentLikes = parseInt(countEl.textContent);

          const { error } = await supabase
            .from('shared_diaries')
            .update({ likes: currentLikes + 1 })
            .eq('id', id);

          if (!error) {
            countEl.textContent = currentLikes + 1;
          } else {
            alert('좋아요 처리 중 오류 발생');
          }
        });
      });
    }

    function attachSubscribeHandlers() {
      diaryList.querySelectorAll('.subscribe-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const followeeId = btn.dataset.uid;

          const { error } = await supabase
            .from('subscriptions')
            .insert({
              follower_id: currentUserId,
              following_id: followeeId
            });

          if (!error) {
            currentSubscriptions.push(followeeId);
            renderDiaries(
              document.querySelector('.emotion-filter.active')?.dataset.emotion || 'all',
              searchInput.value.trim()
            );
          } else {
            alert('구독 실패');
          }
        });
      });
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const emotion = btn.dataset.emotion;
        const keyword = searchInput.value.trim();
        renderDiaries(emotion, keyword);
      });
    });

    searchInput.addEventListener('input', () => {
      const keyword = searchInput.value.trim();
      const activeBtn = document.querySelector('.emotion-filter.active');
      const emotion = activeBtn ? activeBtn.dataset.emotion : 'all';
      renderDiaries(emotion, keyword);
    });

    loadSharedDiaries();
  </script>

</body>
</html>
