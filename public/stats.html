<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI ê°ì • ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'emotion-happy': '#10B981',
            'emotion-sad': '#3B82F6',
            'emotion-angry': '#EF4444',
            'emotion-anxious': '#F59E0B',
            'emotion-neutral': '#6B7280'
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'bounce-in': 'bounceIn 0.6s ease-out',
            'counter': 'counter 2s ease-out'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.3); }
      50% { opacity: 1; transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }

    @keyframes counter {
      from { transform: scale(0.5); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stats-card {
      transition: all 0.3s ease;
    }

    .stats-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    .metric-number {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }

    /* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .dashboard-card {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    /* ì¹´ë“œ í—¤ë” */
    .card-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f1f3f5;
    }

    .card-header h3 {
      font-size: 1.25rem;
      font-weight: bold;
      color: #495057;
      margin: 0;
    }

    /* AI ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ */
    .ai-insights-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      grid-column: 1 / -1;
    }

    .ai-insights-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .ai-insights-header h3 {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0;
      color: white;
    }

    .ai-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      backdrop-filter: blur(10px);
    }

    .ai-insights-content {
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    .ai-insights-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn-ai-detail, .btn-ai-recommend {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
      padding: 0.8rem 1.2rem;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      backdrop-filter: blur(10px);
    }

    .btn-ai-detail:hover, .btn-ai-recommend:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .emotion-profile-card {
      background: linear-gradient(135deg, #74c0fc, #339af0);
      color: white;
    }

    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .profile-header h3 {
      color: white !important;
      margin: 0;
    }

    .total-entries {
      background: rgba(255,255,255,0.2);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: bold;
    }

    .top-emotions h4 {
      color: white;
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
    }

    .profile-stats {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .stat-item {
      background: rgba(255, 255, 255, 0.15);
      padding: 1rem;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .stat-item strong {
      color: rgba(255, 255, 255, 0.9);
      margin-right: 0.5rem;
    }

    .emotion-badges {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .emotion-badge {
      background: rgba(255,255,255,0.2);
      padding: 0.8rem 1.2rem;
      border-radius: 25px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      backdrop-filter: blur(10px);
    }

    .emotion-percentage {
      font-weight: bold;
      font-size: 1.1rem;
    }

    canvas {
      background: rgba(255,255,255,0.9);
      border-radius: 15px;
      padding: 1rem;
      margin: 1rem 0;
      max-height: 400px;
      width: 100% !important;
      height: auto !important;
    }

    .dashboard-card canvas {
      max-height: 300px;
    }

    .ai-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .ai-modal {
      background: white;
      border-radius: 20px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .ai-modal-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 1.5rem;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: background-color 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .ai-modal-body {
      padding: 2rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      font-size: 1.1rem;
      color: #666;
    }

    .detailed-analysis {
      space-y: 1.5rem;
    }

    .analysis-section {
      margin-bottom: 2rem;
    }

    .complexity-meter {
      width: 100%;
      height: 10px;
      background: #f1f3f5;
      border-radius: 10px;
      overflow: hidden;
      margin: 0.5rem 0;
    }

    .meter-fill {
      height: 100%;
      background: linear-gradient(90deg, #51cf66, #74c0fc);
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .keyword-tag {
      background: #e9ecef;
      color: #495057;
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.9rem;
    }

    .ai-insight, .personalized-advice {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      border-left: 4px solid #74c0fc;
      line-height: 1.6;
    }

    .similar-entries {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .similar-entry {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      border-left: 4px solid #51cf66;
    }

    .entry-date, .entry-emotion {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .entry-preview {
      color: #343a40;
      line-height: 1.4;
    }

    .recommendations {
      space-y: 2rem;
    }

    .recommendation-section {
      margin-bottom: 2rem;
    }

    .recommendation-list {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      margin-top: 1rem;
    }

    .recommendation-item {
      background: #e7f5ff;
      padding: 1rem;
      border-radius: 10px;
      border-left: 4px solid #339af0;
    }

    .quote-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .quote-item {
      background: #fff3cd;
      padding: 1.2rem;
      border-radius: 10px;
      border-left: 4px solid #ffc107;
      font-style: italic;
      font-size: 1.05rem;
    }

    .recommendation-actions {
      margin-top: 2rem;
      text-align: center;
    }

    .btn-apply-recommendation {
      background: linear-gradient(135deg, #51cf66, #37b24d);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-apply-recommendation:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(55, 178, 77, 0.3);
    }

    .btn-apply-recommendation:disabled {
      background: #51cf66;
      cursor: not-allowed;
      transform: none;
    }

    #no-data {
      text-align: center;
      margin-top: 2rem;
      color: rgba(255,255,255,0.8);
      font-size: 1.1rem;
      background: rgba(255,255,255,0.1);
      padding: 2rem;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .dashboard-card {
        padding: 1.5rem;
      }

      .ai-insights-actions {
        flex-direction: column;
      }

      .emotion-badges {
        flex-direction: column;
      }

      .profile-stats {
        gap: 0.5rem;
      }

      .stat-item {
        padding: 0.8rem;
      }

      h1 {
        font-size: 2rem !important;
      }

      .ai-insights-header h3 {
        font-size: 1.25rem;
      }

      .metric-number {
        font-size: 2rem;
      }

      canvas {
        padding: 0.5rem;
      }
    }

    @media (max-width: 480px) {
      .dashboard-card {
        padding: 1rem;
      }

      .card-header {
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
      }

      .emotion-badge {
        padding: 0.6rem 1rem;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="navbar">
    <div class="nav-container">
      <a href="dashboard.html" class="nav-brand">ğŸŒ™ í•œ ìˆ¨ì˜ ìœ„ë¡œ</a>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">ëŒ€ì‹œë³´ë“œ</a>
        </li>
        <li class="nav-item">
          <a href="write-diary.html" class="nav-link">ì¼ê¸° ì‘ì„±</a>
        </li>
        <li class="nav-item">
          <a href="my-diary.html" class="nav-link">ë‚´ ì¼ê¸°</a>
        </li>
        <li class="nav-item">
          <a href="anonymous-community.html" class="nav-link">ìµëª… ì»¤ë®¤ë‹ˆí‹°</a>
        </li>
        <li class="nav-item">
          <a href="stats.html" class="nav-link active">í†µê³„</a>
        </li>
        <li class="nav-item">
          <a href="my-page.html" class="nav-link">ë§ˆì´í˜ì´ì§€</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="max-w-7xl mx-auto px-4 py-6 pt-24">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="gradient-bg rounded-3xl p-8 text-white mb-6 animate-fade-in">
        <h1 class="text-4xl font-bold mb-3">ğŸ§  AI ê°ì • ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
        <p class="text-lg opacity-90">GPT-4oê°€ ë¶„ì„í•˜ëŠ” ë‹¹ì‹ ì˜ ê°ì • ì—¬ì •</p>
        <div class="mt-4 text-sm opacity-80">
          ğŸ“Š ì‹¤ì‹œê°„ ë¶„ì„ Â· ğŸ¯ íŒ¨í„´ ì¸ì‹ Â· ğŸ’¡ ê°œì¸í™” ì¸ì‚¬ì´íŠ¸
        </div>
      </div>
    </div>

    <!-- No Data Message -->
    <div id="no-data" style="display: none;">
      <h2>ğŸ“ ì•„ì§ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
      <p>ì²« ë²ˆì§¸ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ì—¬ AI ë¶„ì„ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
      <a href="write-diary.html" style="color: white; text-decoration: underline;">ì¼ê¸° ì“°ëŸ¬ ê°€ê¸° â†’</a>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid" id="main-dashboard" style="display: none;">
    <!-- AI ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ -->
    <div class="dashboard-card ai-insights-card">
      <div id="ai-insights-container">
        <div class="ai-insights-header">
          <h3>ğŸ§  AI ê°ì • ì¸ì‚¬ì´íŠ¸</h3>
          <span class="ai-badge">GPT-4o ë¶„ì„</span>
        </div>
        <div class="ai-insights-content">
          <div class="loading">AIê°€ ë‹¹ì‹ ì˜ ê°ì •ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
        </div>
      </div>
    </div>

    <!-- ê°ì • í”„ë¡œí•„ ì¹´ë“œ -->
    <div class="dashboard-card emotion-profile-card">
      <div id="emotion-profile-container">
        <div class="profile-header">
          <h3>ğŸ“Š ë‚˜ì˜ ê°ì • í”„ë¡œí•„</h3>
          <div class="total-entries">ë¶„ì„ ì¤‘...</div>
        </div>
        <div class="loading">ê°ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <!-- ê°ì • ë³€í™” íŠ¸ë Œë“œ -->
    <div class="dashboard-card">
      <div class="card-header">
        <h3>ğŸ“ˆ ê°ì • ë³€í™” ì¶”ì„¸</h3>
      </div>
      <canvas id="mood-trend-chart"></canvas>
    </div>

    <!-- ìƒì„¸ ë¶„ì„ ì°¨íŠ¸ -->
    <div class="dashboard-card">
      <div class="card-header">
        <h3>ğŸ¯ ê°ì • ë¶„í¬ ë¶„ì„</h3>
      </div>
      <canvas id="emotion-pie-chart"></canvas>
    </div>

    <!-- ì‹œê°„ëŒ€ë³„ ê°ì • íŒ¨í„´ -->
    <div class="dashboard-card">
      <div class="card-header">
        <h3>â° ì‹œê°„ëŒ€ë³„ ê°ì • íŒ¨í„´</h3>
      </div>
      <canvas id="hourly-pattern-chart"></canvas>
    </div>

    <!-- ìš”ì¼ë³„ ê°ì • ë¶„ì„ -->
    <div class="dashboard-card">
      <div class="card-header">
        <h3>ğŸ“… ìš”ì¼ë³„ ê°ì • ë¶„ì„</h3>
      </div>
      <canvas id="weekly-pattern-chart"></canvas>
    </div>
    </div>
    <!-- End of Dashboard Grid -->
  </div>
  <!-- End of Main Container -->

  <script type="module">
    import { supabase } from './js/supabase.js';
    import { checkAuth } from './js/auth.js';
    import { aiDashboard } from './js/ai-dashboard.js';

    checkAuth();

    // AI ëŒ€ì‹œë³´ë“œ ì „ì—­ ì ‘ê·¼ì„ ìœ„í•œ ì„¤ì •
    window.aiDashboard = aiDashboard;

    // í™•ì¥ëœ ê°ì • ì ìˆ˜ ë§¤í•‘ (24ê°€ì§€ ê°ì •)
    const emotionScores = {
      // ê¸ì • ê°ì •
      joy: 80, contentment: 60, gratitude: 70, love: 85, excitement: 75,
      pride: 65, hope: 55, relief: 50,
      // ë¶€ì • ê°ì •
      sadness: -60, grief: -80, anger: -70, frustration: -55, anxiety: -65,
      fear: -75, guilt: -45, shame: -50, loneliness: -60, disappointment: -40,
      // ì¤‘ì„± ê°ì •
      calm: 20, contemplative: 10, curious: 30, nostalgic: 0, confused: -10, indifferent: 0,
      // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ ë§¤í•‘
      happy: 70, sad: -60, angry: -70, anxious: -65, neutral: 0,
      excited: 75, peaceful: 20
    };

    const weekDays = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
    const hours = Array.from({ length: 24 }, (_, i) => `${i}:00`);

    async function loadAIDashboard() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        // í™•ì¥ëœ ê°ì • ë°ì´í„° ì¡°íšŒ (ìƒˆ ì»¬ëŸ¼ë“¤ í¬í•¨)
        const { data, error } = await supabase
          .from('diaries')
          .select(`
            emotion,
            created_at,
            mood_score,
            keywords,
            ai_insights,
            emotion_confidence,
            complexity_score
          `)
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
          document.getElementById('no-data').style.display = 'block';
          return;
        }

        if (!data || data.length === 0) {
          document.getElementById('no-data').style.display = 'block';
          return;
        }

        // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
        document.getElementById('main-dashboard').style.display = 'grid';

        // ê°ì • í†µê³„ ê³„ì‚°
        const emotionStats = calculateEmotionStats(data);

        // AI ì¸ì‚¬ì´íŠ¸ ìƒì„±
        await generateAIInsights(data.slice(0, 10)); // ìµœê·¼ 10ê°œ ì¼ê¸° ë¶„ì„

        // ê°ì • í”„ë¡œí•„ í‘œì‹œ
        displayEmotionProfile(emotionStats);

        // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        drawAllCharts(data, emotionStats);

      } catch (error) {
        console.error('AI ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('no-data').style.display = 'block';
      }
    }

    function calculateEmotionStats(data) {
      const stats = {
        total: data.length,
        emotions: {},
        recentEmotions: [],
        averageMood: 0,
        averageConfidence: 0,
        averageComplexity: 0
      };

      // ëª¨ë“  ê°ì • ì´ˆê¸°í™”
      Object.keys(emotionScores).forEach(emotion => {
        stats.emotions[emotion] = 0;
      });

      // í†µê³„ ê³„ì‚°
      let totalMood = 0, totalConfidence = 0, totalComplexity = 0;
      let validMoods = 0, validConfidences = 0, validComplexities = 0;

      data.forEach(entry => {
        // ê°ì •ë³„ ì¹´ìš´íŠ¸
        if (stats.emotions[entry.emotion] !== undefined) {
          stats.emotions[entry.emotion]++;
        }

        // í‰ê·  ê³„ì‚°ì„ ìœ„í•œ í•©ê³„
        if (entry.mood_score !== null && entry.mood_score !== undefined) {
          totalMood += entry.mood_score;
          validMoods++;
        }

        if (entry.emotion_confidence !== null && entry.emotion_confidence !== undefined) {
          totalConfidence += entry.emotion_confidence;
          validConfidences++;
        }

        if (entry.complexity_score !== null && entry.complexity_score !== undefined) {
          totalComplexity += entry.complexity_score;
          validComplexities++;
        }

        // ìµœê·¼ ê°ì • (ìµœê·¼ 30ì¼)
        const entryDate = new Date(entry.created_at);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        if (entryDate >= thirtyDaysAgo) {
          stats.recentEmotions.push({
            emotion: entry.emotion,
            date: entry.created_at,
            mood_score: entry.mood_score,
            insights: entry.ai_insights
          });
        }
      });

      // í‰ê·  ê³„ì‚°
      stats.averageMood = validMoods > 0 ? totalMood / validMoods : 0;
      stats.averageConfidence = validConfidences > 0 ? totalConfidence / validConfidences : 0;
      stats.averageComplexity = validComplexities > 0 ? totalComplexity / validComplexities : 0;

      return stats;
    }

    async function generateAIInsights(recentData) {
      try {
        // ë¡œì»¬ ê°œë°œ í™˜ê²½ ê°ì§€
        const isLocalDev = window.location.hostname === 'localhost' ||
                          window.location.hostname === '127.0.0.1' ||
                          window.location.port;

        if (isLocalDev) {
          // ë¡œì»¬ ê°œë°œìš© ëª¨ì˜ AI ì¸ì‚¬ì´íŠ¸ ìƒì„±
          const mockInsight = generateMockAIInsight(recentData);
          displayAIInsights(mockInsight);
          return;
        }

        const { data: { session } } = await supabase.auth.getSession();
        const token = session?.access_token;

        if (!token) {
          displayAIInsights('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }

        const response = await fetch('/.netlify/functions/emotion-summary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            emotions: recentData.map(entry => ({
              emotion: entry.emotion,
              score: entry.mood_score || 0,
              date: entry.created_at
            }))
          })
        });

        if (response.ok) {
          const result = await response.json();
          displayAIInsights(result.summary);
        } else {
          const fallbackInsight = generateMockAIInsight(recentData);
          displayAIInsights(`${fallbackInsight} (ì˜¤í”„ë¼ì¸ ë¶„ì„)`);
        }
      } catch (error) {
        console.error('AI ì¸ì‚¬ì´íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
        const fallbackInsight = generateMockAIInsight(recentData);
        displayAIInsights(`${fallbackInsight} (ë¡œì»¬ ë¶„ì„)`);
      }
    }

    // ë¡œì»¬ ê°œë°œìš© ëª¨ì˜ AI ì¸ì‚¬ì´íŠ¸ ìƒì„±
    function generateMockAIInsight(recentData) {
      if (!recentData || recentData.length === 0) {
        return 'ì•„ì§ ì¶©ë¶„í•œ ê°ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë” ë§ì€ ì¼ê¸°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!';
      }

      // ê°ì • ë¶„í¬ ë¶„ì„
      const emotionCounts = {};
      let totalMood = 0;
      let validMoods = 0;

      recentData.forEach(entry => {
        emotionCounts[entry.emotion] = (emotionCounts[entry.emotion] || 0) + 1;
        if (entry.mood_score !== null && entry.mood_score !== undefined) {
          totalMood += entry.mood_score;
          validMoods++;
        }
      });

      const avgMood = validMoods > 0 ? totalMood / validMoods : 0;
      const dominantEmotion = Object.keys(emotionCounts).reduce((a, b) =>
        emotionCounts[a] > emotionCounts[b] ? a : b
      );

      // ê°ì •ë³„ ì„¤ëª…
      const emotionDescriptions = {
        joy: 'ê¸°ì¨ì´ ê°€ë“í•œ', contentment: 'ë§Œì¡±ìŠ¤ëŸ¬ìš´', gratitude: 'ê°ì‚¬ê°€ ë„˜ì¹˜ëŠ”',
        love: 'ì‚¬ë‘ì´ ì¶©ë§Œí•œ', excitement: 'ì„¤ë ˆëŠ”', pride: 'ìë‘ìŠ¤ëŸ¬ìš´',
        hope: 'í¬ë§ì°¬', relief: 'ì•ˆë„í•˜ëŠ”', sadness: 'ìŠ¬í””ì´ ìˆëŠ”',
        grief: 'ë¹„íƒ„ì— ë¹ ì§„', anger: 'ë¶„ë…¸ê°€ ìˆëŠ”', frustration: 'ì¢Œì ˆê°ì´ ìˆëŠ”',
        anxiety: 'ë¶ˆì•ˆí•œ', fear: 'ë‘ë ¤ì›€ì´ ìˆëŠ”', guilt: 'ì£„ì±…ê°ì´ ìˆëŠ”',
        shame: 'ìˆ˜ì¹˜ì‹¬ì„ ëŠë¼ëŠ”', loneliness: 'ì™¸ë¡œìš´', disappointment: 'ì‹¤ë§ìŠ¤ëŸ¬ìš´',
        calm: 'í‰ì˜¨í•œ', contemplative: 'ì‚¬ìƒ‰ì ì¸', curious: 'í˜¸ê¸°ì‹¬ ë§ì€',
        nostalgic: 'ê·¸ë¦¬ì›€ì´ ìˆëŠ”', confused: 'í˜¼ë€ìŠ¤ëŸ¬ìš´', indifferent: 'ë¬´ê´€ì‹¬í•œ',
        happy: 'í–‰ë³µí•œ', sad: 'ìŠ¬í”ˆ', angry: 'í™”ê°€ ë‚œ', anxious: 'ë¶ˆì•ˆí•œ',
        neutral: 'í‰ë²”í•œ', excited: 'ì‹ ë‚˜ëŠ”', peaceful: 'í‰í™”ë¡œìš´'
      };

      let analysis = '';

      // ê¸°ë¶„ ì ìˆ˜ ê¸°ë°˜ ë¶„ì„
      if (avgMood > 30) {
        analysis = `ìµœê·¼ ${recentData.length}ì¼ ë™ì•ˆ ì „ë°˜ì ìœ¼ë¡œ ê¸ì •ì ì¸ ì‹œê°„ì„ ë³´ë‚´ê³  ê³„ì‹œë„¤ìš”! `;
        analysis += `íŠ¹íˆ ${emotionDescriptions[dominantEmotion] || dominantEmotion} ê°ì •ì´ ë‘ë“œëŸ¬ì§‘ë‹ˆë‹¤. `;
        analysis += 'ì´ëŸ° ì¢‹ì€ ì—ë„ˆì§€ë¥¼ ê³„ì† ìœ ì§€í•˜ì‹œê¸¸ ë°”ë¼ìš”. ğŸ˜Š';
      } else if (avgMood < -30) {
        analysis = `ìµœê·¼ ${recentData.length}ì¼ ë™ì•ˆ í˜ë“  ì‹œê°„ì„ ë³´ë‚´ê³  ê³„ì‹œëŠ” ê²ƒ ê°™ì•„ìš”. `;
        analysis += `${emotionDescriptions[dominantEmotion] || dominantEmotion} ê°ì •ì´ ì£¼ë¥¼ ì´ë£¨ê³  ìˆìŠµë‹ˆë‹¤. `;
        analysis += 'ì¶©ë¶„í•œ íœ´ì‹ê³¼ ìê¸° ëŒë´„ì´ í•„ìš”í•  ê²ƒ ê°™ì•„ìš”. ğŸ’™';
      } else {
        analysis = `ìµœê·¼ ${recentData.length}ì¼ ë™ì•ˆ ë¹„êµì  ê· í˜•ì¡íŒ ê°ì • ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ê³„ì‹œë„¤ìš”. `;
        analysis += `${emotionDescriptions[dominantEmotion] || dominantEmotion} ê°ì •ì´ ê°€ì¥ ë§ì´ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤. `;
        analysis += 'í˜„ì¬ì˜ ì•ˆì •ì ì¸ ìƒíƒœë¥¼ ì˜ ìœ ì§€í•´ë³´ì„¸ìš”. ğŸ˜Œ';
      }

      return analysis;
    }

    function displayAIInsights(summary) {
      const container = document.getElementById('ai-insights-container');
      container.innerHTML = `
        <div class="ai-insights-header">
          <h3>ğŸ§  AI ê°ì • ì¸ì‚¬ì´íŠ¸</h3>
          <span class="ai-badge">GPT-4o ë¶„ì„</span>
        </div>
        <div class="ai-insights-content">
          <p>${summary}</p>
        </div>
        <div class="ai-insights-actions">
          <button onclick="aiDashboard.getDetailedAnalysis()" class="btn-ai-detail">
            ğŸ“Š ìƒì„¸ ë¶„ì„ ë³´ê¸°
          </button>
          <button onclick="aiDashboard.getRecommendations()" class="btn-ai-recommend">
            ğŸ’¡ ë§ì¶¤ ì¶”ì²œ ë°›ê¸°
          </button>
        </div>
      `;
    }

    function displayEmotionProfile(stats) {
      // ìƒìœ„ 3ê°œ ê°ì • ì¶”ì¶œ
      const topEmotions = Object.entries(stats.emotions)
        .filter(([emotion, count]) => count > 0)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 3);

      const container = document.getElementById('emotion-profile-container');
      container.innerHTML = `
        <div class="profile-header">
          <h3>ğŸ“Š ë‚˜ì˜ ê°ì • í”„ë¡œí•„</h3>
          <div class="total-entries">ì´ ${stats.total}ê°œ ì¼ê¸°</div>
        </div>

        <div class="top-emotions">
          <h4>ì£¼ìš” ê°ì • TOP 3</h4>
          <div class="emotion-badges">
            ${topEmotions.map(([emotion, count]) => {
              const percentage = Math.round((count / stats.total) * 100);
              return `
                <div class="emotion-badge ${emotion}">
                  <span class="emotion-icon">${getEmotionIcon(emotion)}</span>
                  <span class="emotion-name">${getEmotionLabel(emotion)}</span>
                  <span class="emotion-percentage">${percentage}%</span>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <div class="profile-stats">
          <div class="stat-item">
            <strong>í‰ê·  ê¸°ë¶„ ì ìˆ˜:</strong> ${Math.round(stats.averageMood)}
          </div>
          <div class="stat-item">
            <strong>AI ë¶„ì„ ì‹ ë¢°ë„:</strong> ${Math.round(stats.averageConfidence * 100)}%
          </div>
          <div class="stat-item">
            <strong>ê°ì • ë³µì¡ë„:</strong> ${Math.round(stats.averageComplexity * 100)}%
          </div>
        </div>
      `;
    }

    function drawAllCharts(data, stats) {
      // ê°ì • ë¶„í¬ íŒŒì´ ì°¨íŠ¸
      drawEmotionPieChart(stats);

      // ê¸°ë¶„ ë³€í™” íŠ¸ë Œë“œ ì°¨íŠ¸
      drawMoodTrendChart(data);

      // ì‹œê°„ëŒ€ë³„ íŒ¨í„´ ì°¨íŠ¸
      drawHourlyPatternChart(data);

      // ìš”ì¼ë³„ íŒ¨í„´ ì°¨íŠ¸
      drawWeeklyPatternChart(data);
    }

    function drawEmotionPieChart(stats) {
      const ctx = document.getElementById('emotion-pie-chart');
      if (!ctx) return;

      const validEmotions = Object.entries(stats.emotions)
        .filter(([emotion, count]) => count > 0);

      if (validEmotions.length === 0) {
        ctx.getContext('2d').fillText('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 150, 150);
        return;
      }

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: validEmotions.map(([emotion]) => getEmotionLabel(emotion)),
          datasets: [{
            data: validEmotions.map(([, count]) => count),
            backgroundColor: validEmotions.map(([emotion]) => getEmotionColor(emotion)),
            borderWidth: 3,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true,
                font: { size: 12 }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((context.parsed / total) * 100);
                  return `${context.label}: ${percentage}%`;
                }
              }
            }
          }
        }
      });
    }

    function drawMoodTrendChart(data) {
      const ctx = document.getElementById('mood-trend-chart');
      if (!ctx) return;

      // ìµœê·¼ 30ì¼ ë°ì´í„° ì¤€ë¹„
      const last30Days = [];
      const today = new Date();

      for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];

        const dayData = data.filter(entry =>
          entry.created_at.split('T')[0] === dateStr
        );

        const avgMood = dayData.length > 0
          ? dayData.reduce((sum, entry) => sum + (entry.mood_score || 0), 0) / dayData.length
          : null;

        last30Days.push({
          date: date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }),
          mood: avgMood
        });
      }

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: last30Days.map(d => d.date),
          datasets: [{
            label: 'ê¸°ë¶„ ì ìˆ˜',
            data: last30Days.map(d => d.mood),
            borderColor: '#74c0fc',
            backgroundColor: 'rgba(116, 192, 252, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#74c0fc',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2,
          scales: {
            y: {
              beginAtZero: true,
              min: -100,
              max: 100,
              grid: { color: 'rgba(0,0,0,0.1)' },
              ticks: {
                callback: function(value) {
                  if (value > 50) return 'ğŸ˜Š ì¢‹ìŒ';
                  if (value > 0) return 'ğŸ˜ ë³´í†µ';
                  if (value > -50) return 'ğŸ˜” ì•ˆ ì¢‹ìŒ';
                  return 'ğŸ˜¢ ë‚˜ì¨';
                }
              }
            },
            x: { grid: { color: 'rgba(0,0,0,0.1)' } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  if (value === null) return 'ë°ì´í„° ì—†ìŒ';
                  let emoji = 'ğŸ˜';
                  if (value > 50) emoji = 'ğŸ˜Š';
                  else if (value > 0) emoji = 'ğŸ™‚';
                  else if (value > -50) emoji = 'ğŸ˜”';
                  else emoji = 'ğŸ˜¢';
                  return `${emoji} ê¸°ë¶„ ì ìˆ˜: ${Math.round(value)}`;
                }
              }
            }
          }
        }
      });
    }

    function drawHourlyPatternChart(data) {
      const ctx = document.getElementById('hourly-pattern-chart');
      if (!ctx) return;

      const hourlyData = Array(24).fill(0).map((_, hour) => {
        const hourData = data.filter(entry => {
          const entryHour = new Date(entry.created_at).getHours();
          return entryHour === hour;
        });

        return hourData.length > 0
          ? hourData.reduce((sum, entry) => sum + (entry.mood_score || 0), 0) / hourData.length
          : 0;
      });

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: hours,
          datasets: [{
            label: 'ì‹œê°„ëŒ€ë³„ í‰ê·  ê¸°ë¶„',
            data: hourlyData,
            backgroundColor: hours.map((_, i) => {
              const value = hourlyData[i];
              if (value > 30) return 'rgba(116, 192, 252, 0.8)';
              if (value > 0) return 'rgba(116, 192, 252, 0.5)';
              if (value > -30) return 'rgba(255, 135, 135, 0.5)';
              return 'rgba(255, 135, 135, 0.8)';
            }),
            borderColor: '#74c0fc',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2,
          scales: {
            y: {
              min: -100,
              max: 100,
              grid: { color: 'rgba(0,0,0,0.1)' }
            },
            x: { grid: { color: 'rgba(0,0,0,0.1)' } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    function drawWeeklyPatternChart(data) {
      const ctx = document.getElementById('weekly-pattern-chart');
      if (!ctx) return;

      const weeklyData = weekDays.map(day => {
        const dayIndex = weekDays.indexOf(day);
        const dayData = data.filter(entry => {
          const entryDay = new Date(entry.created_at).getDay();
          const mappedDay = entryDay === 0 ? 6 : entryDay - 1; // ì¼ìš”ì¼ì„ 6ìœ¼ë¡œ ë§¤í•‘
          return mappedDay === dayIndex;
        });

        return dayData.length > 0
          ? dayData.reduce((sum, entry) => sum + (entry.mood_score || 0), 0) / dayData.length
          : 0;
      });

      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: weekDays,
          datasets: [{
            label: 'ìš”ì¼ë³„ í‰ê·  ê¸°ë¶„',
            data: weeklyData,
            borderColor: '#51cf66',
            backgroundColor: 'rgba(81, 207, 102, 0.2)',
            borderWidth: 3,
            pointBackgroundColor: '#51cf66',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1,
          scales: {
            r: {
              min: -100,
              max: 100,
              grid: { color: 'rgba(0,0,0,0.1)' },
              pointLabels: { font: { size: 12 } }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function getEmotionIcon(emotion) {
      const icons = {
        joy: 'ğŸ˜„', contentment: 'ğŸ˜Š', gratitude: 'ğŸ™', love: 'â¤ï¸', excitement: 'ğŸ¤©',
        pride: 'ğŸ˜¤', hope: 'ğŸŒŸ', relief: 'ğŸ˜Œ',
        sadness: 'ğŸ˜¢', grief: 'ğŸ˜­', anger: 'ğŸ˜ ', frustration: 'ğŸ˜¤', anxiety: 'ğŸ˜°',
        fear: 'ğŸ˜¨', guilt: 'ğŸ˜”', shame: 'ğŸ˜³', loneliness: 'ğŸ˜', disappointment: 'ğŸ˜•',
        calm: 'ğŸ˜Œ', contemplative: 'ğŸ¤”', curious: 'ğŸ¤¨', nostalgic: 'ğŸ˜Œ', confused: 'ğŸ˜•', indifferent: 'ğŸ˜',
        happy: 'ğŸ˜Š', sad: 'ğŸ˜¢', angry: 'ğŸ˜ ', anxious: 'ğŸ˜°', neutral: 'ğŸ˜',
        excited: 'ğŸ¤©', peaceful: 'ğŸ˜Œ'
      };
      return icons[emotion] || 'ğŸ˜';
    }

    function getEmotionLabel(emotion) {
      const labels = {
        joy: 'ê¸°ì¨', contentment: 'ë§Œì¡±', gratitude: 'ê°ì‚¬', love: 'ì‚¬ë‘', excitement: 'í¥ë¶„/ì„¤ë ˜',
        pride: 'ìë¶€ì‹¬', hope: 'í¬ë§', relief: 'ì•ˆë„',
        sadness: 'ìŠ¬í””', grief: 'ë¹„íƒ„', anger: 'ë¶„ë…¸', frustration: 'ì¢Œì ˆ', anxiety: 'ë¶ˆì•ˆ',
        fear: 'ë‘ë ¤ì›€', guilt: 'ì£„ì±…ê°', shame: 'ìˆ˜ì¹˜ì‹¬', loneliness: 'ì™¸ë¡œì›€', disappointment: 'ì‹¤ë§',
        calm: 'í‰ì˜¨', contemplative: 'ì‚¬ìƒ‰ì ', curious: 'í˜¸ê¸°ì‹¬', nostalgic: 'ê·¸ë¦¬ì›€', confused: 'í˜¼ë€', indifferent: 'ë¬´ê´€ì‹¬',
        happy: 'í–‰ë³µ', sad: 'ìŠ¬í””', angry: 'ë¶„ë…¸', anxious: 'ë¶ˆì•ˆ', neutral: 'ë³´í†µ',
        excited: 'ì‹ ë‚¨', peaceful: 'í‰ì˜¨'
      };
      return labels[emotion] || 'ì•Œ ìˆ˜ ì—†ìŒ';
    }

    function getEmotionColor(emotion) {
      const colors = {
        joy: '#74c0fc', contentment: '#69db7c', gratitude: '#ffd43b', love: '#ff6b9d', excitement: '#ff8cc8',
        pride: '#fd7e14', hope: '#fcc419', relief: '#51cf66',
        sadness: '#74c0fc', grief: '#495057', anger: '#ff8787', frustration: '#ffa94d', anxiety: '#ffd43b',
        fear: '#6c757d', guilt: '#9775fa', shame: '#e03131', loneliness: '#868e96', disappointment: '#adb5bd',
        calm: '#51cf66', contemplative: '#9775fa', curious: '#ff922b', nostalgic: '#da77f2', confused: '#9775fa', indifferent: '#ced4da',
        happy: '#74c0fc', sad: '#ff8787', angry: '#ff8787', anxious: '#ffd43b', neutral: '#ced4da',
        excited: '#ff6b9d', peaceful: '#51cf66'
      };
      return colors[emotion] || '#ced4da';
    }

    // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
    loadAIDashboard();
  </script>

</body>
</html>