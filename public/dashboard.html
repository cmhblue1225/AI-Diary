<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ëŒ€ì‹œë³´ë“œ - í•œ ìˆ¨ì˜ ìœ„ë¡œ</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'emotion-happy': '#10B981',
            'emotion-sad': '#3B82F6',
            'emotion-angry': '#EF4444',
            'emotion-anxious': '#F59E0B',
            'emotion-neutral': '#6B7280'
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'bounce-in': 'bounceIn 0.6s ease-out'
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.3); }
      50% { opacity: 1; transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .emotion-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }

    .emotion-card:hover {
      transform: translateY(-4px);
      background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.1) 100%);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="navbar">
    <div class="nav-container">
      <a href="dashboard.html" class="nav-brand">ğŸŒ™ í•œ ìˆ¨ì˜ ìœ„ë¡œ</a>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link active">ëŒ€ì‹œë³´ë“œ</a>
        </li>
        <li class="nav-item">
          <a href="write-diary.html" class="nav-link">ì¼ê¸° ì‘ì„±</a>
        </li>
        <li class="nav-item">
          <a href="my-diary.html" class="nav-link">ë‚´ ì¼ê¸°</a>
        </li>
        <li class="nav-item">
          <a href="anonymous-community.html" class="nav-link">ìµëª… ì»¤ë®¤ë‹ˆí‹°</a>
        </li>
        <li class="nav-item">
          <a href="stats.html" class="nav-link">í†µê³„</a>
        </li>
        <li class="nav-item">
          <a href="my-page.html" class="nav-link">ë§ˆì´í˜ì´ì§€</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="max-w-6xl mx-auto px-4 py-6 pt-24">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="gradient-bg rounded-3xl p-8 text-white mb-6 animate-fade-in">
        <h1 class="text-4xl font-bold mb-3">ğŸ“Š ê°ì • ëŒ€ì‹œë³´ë“œ</h1>
        <p class="text-lg opacity-90">ë‹¹ì‹ ì˜ ê°ì • ì—¬ì •ì„ í•œëˆˆì— ì‚´í´ë³´ì„¸ìš”</p>
        <div class="mt-4 text-sm opacity-80">
          ğŸŒŸ AI ê¸°ë°˜ ê°ì • ë¶„ì„ Â· ì¼ê¸° ì‘ì„± Â· ê°ì • í†µê³„
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid lg:grid-cols-2 gap-8">
      <!-- Recent Diaries -->
      <div class="bg-white rounded-2xl p-6 shadow-lg animate-bounce-in">
        <div class="flex items-center mb-6">
          <div class="text-2xl mr-3">ğŸ“</div>
          <h2 class="text-xl font-bold text-gray-800">ìµœê·¼ ë‚´ ì¼ê¸°</h2>
        </div>
        <div id="my-diaries" class="space-y-4">
          <div class="text-center py-8 text-gray-500">
            <div class="animate-spin w-8 h-8 border-2 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"></div>
            ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>

      <!-- Popular Shared Diaries -->
      <div class="bg-white rounded-2xl p-6 shadow-lg animate-bounce-in" style="animation-delay: 0.2s;">
        <div class="flex items-center mb-6">
          <div class="text-2xl mr-3">ğŸ”¥</div>
          <h2 class="text-xl font-bold text-gray-800">ì¸ê¸° ê³µìœ  ì¼ê¸°</h2>
        </div>
        <div id="shared-diaries" class="space-y-4">
          <div class="text-center py-8 text-gray-500">
            <div class="animate-spin w-8 h-8 border-2 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"></div>
            ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>
    </div>

    <!-- Weekly Summary -->
    <div class="mt-8">
      <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl p-8 border border-purple-100 animate-slide-up">
        <div class="flex items-center mb-6">
          <div class="text-3xl mr-4">ğŸ§ </div>
          <h2 class="text-2xl font-bold text-gray-800">GPT ì£¼ê°„ ê°ì • ìš”ì•½</h2>
        </div>
        <div id="gpt-summary" class="text-gray-600 leading-relaxed">
          <div class="flex items-center">
            <div class="animate-spin w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full mr-4"></div>
            AIê°€ ë‹¹ì‹ ì˜ ê°ì • íŒ¨í„´ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap justify-center gap-4 mt-12 animate-bounce-in">
      <a href="write-diary.html"
         class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
        <span class="mr-2">âœï¸</span>
        ì¼ê¸° ì“°ê¸°
      </a>
      <a href="stats.html"
         class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
        <span class="mr-2">ğŸ“ˆ</span>
        ê°ì • í†µê³„
      </a>
      <a href="anonymous-community.html"
         class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
        <span class="mr-2">ğŸŒ</span>
        ì»¤ë®¤ë‹ˆí‹°
      </a>
    </div>
  </div>

  <script type="module">
    import { supabase } from './js/supabase.js';
    import { checkAuth } from './js/auth.js';

    checkAuth();

    async function loadDashboard() {
      const { data: { user } } = await supabase.auth.getUser();

      const { data: myDiaries } = await supabase
        .from('diaries')
        .select('id, content, created_at')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false })
        .limit(3);

      const myEl = document.getElementById('my-diaries');
      myEl.innerHTML = myDiaries.length === 0
        ? `<div class="text-center py-8 text-gray-500">
             <div class="text-4xl mb-4">ğŸ“</div>
             <p class="text-lg font-medium mb-2">ì•„ì§ ì‘ì„±í•œ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
             <p class="text-sm">ì²« ë²ˆì§¸ ì¼ê¸°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
             <a href="write-diary.html" class="inline-block mt-4 px-6 py-2 bg-indigo-600 text-white rounded-full font-medium hover:bg-indigo-700 transition-colors">
               ì¼ê¸° ì“°ëŸ¬ ê°€ê¸°
             </a>
           </div>`
        : myDiaries.map(d => `
          <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-all duration-300 border border-gray-200">
            <a href="diary-detail.html?id=${d.id}" class="block">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-500">${new Date(d.created_at).toLocaleDateString()}</span>
                <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">ë‚´ ì¼ê¸°</span>
              </div>
              <p class="text-gray-800 leading-relaxed">${d.content.slice(0, 100)}${d.content.length > 100 ? '...' : ''}</p>
            </a>
          </div>
        `).join('');

      const { data: shared } = await supabase
        .from('shared_diaries')
        .select('diary_id, content, likes, created_at')
        .order('likes', { ascending: false })
        .limit(3);

      const sharedEl = document.getElementById('shared-diaries');
      sharedEl.innerHTML = shared.length === 0
        ? `<div class="text-center py-8 text-gray-500">
             <div class="text-4xl mb-4">ğŸŒ</div>
             <p class="text-lg font-medium mb-2">ì•„ì§ ê³µìœ ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
             <p class="text-sm">ì»¤ë®¤ë‹ˆí‹°ì— ì²« ë²ˆì§¸ ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
             <a href="anonymous-community.html" class="inline-block mt-4 px-6 py-2 bg-pink-600 text-white rounded-full font-medium hover:bg-pink-700 transition-colors">
               ì»¤ë®¤ë‹ˆí‹° ê°€ê¸°
             </a>
           </div>`
        : shared.map(d => `
          <div class="bg-gradient-to-br from-pink-50 to-purple-50 rounded-xl p-4 hover:from-pink-100 hover:to-purple-100 transition-all duration-300 border border-pink-100">
            <a href="diary-detail.html?id=${d.diary_id}" class="block">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-500">${new Date(d.created_at).toLocaleDateString()}</span>
                <div class="flex items-center text-sm text-pink-600">
                  <span class="mr-1">â¤ï¸</span>
                  <span class="font-medium">${d.likes}</span>
                </div>
              </div>
              <p class="text-gray-800 leading-relaxed">${d.content.slice(0, 100)}${d.content.length > 100 ? '...' : ''}</p>
            </a>
          </div>
        `).join('');

      const { data: emotions } = await supabase
        .from('diaries')
        .select('emotion, created_at')
        .eq('user_id', user.id);

      const scores = { happy: 2, neutral: 1, anxious: 0, sad: -1, angry: -2 };
      const weekDays = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
      const weekMap = { ì›”: [], í™”: [], ìˆ˜: [], ëª©: [], ê¸ˆ: [], í† : [], ì¼: [] };

      emotions.forEach(entry => {
        const date = new Date(entry.created_at);
        const weekday = weekDays[date.getDay() === 0 ? 6 : date.getDay() - 1];
        const score = scores[entry.emotion];
        if (score !== undefined) {
          weekMap[weekday].push(score);
        }
      });

      const summaryPayload = weekDays.map(day => {
        const arr = weekMap[day];
        const avg = arr.length ? (arr.reduce((a,b) => a+b) / arr.length).toFixed(2) : null;
        return { date: day, score: avg };
      });

      const res = await fetch('https://emotion-gpt-api.onrender.com/api/emotion-summary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ emotions: summaryPayload })
      });

      const result = await res.json();
      const summaryEl = document.getElementById('gpt-summary');
      if (result.summary) {
        summaryEl.innerHTML = `
          <div class="space-y-4">
            <div class="flex items-start">
              <div class="text-2xl mr-3 mt-1">ğŸ¤–</div>
              <div>
                <h3 class="font-semibold text-gray-800 mb-2">AI ê°ì • ë¶„ì„ ê²°ê³¼</h3>
                <p class="text-gray-700 leading-relaxed">${result.summary}</p>
              </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-purple-200">
              <p class="text-sm text-purple-600 font-medium">ğŸ’¡ ê°œì¸í™” íŒ</p>
              <p class="text-sm text-gray-600 mt-1">ì´ ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ ê°ì • ê´€ë¦¬ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”.</p>
            </div>
          </div>
        `;
      } else {
        summaryEl.innerHTML = `
          <div class="text-center py-6">
            <div class="text-3xl mb-3">ğŸ”</div>
            <p class="text-gray-600">ë¶„ì„í•  ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            <p class="text-sm text-gray-500 mt-2">ë” ë§ì€ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ë©´ ì •í™•í•œ ë¶„ì„ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          </div>
        `;
      }
    }

    loadDashboard();
  </script>

  <script type="module" src="./js/components/nav.js"></script>
</body>
</html>
